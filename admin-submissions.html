<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¯¸ì…˜ ì œì¶œ ë‚´ì—­ - Standing Party</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="admin-body">
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <h1 class="login-title">ê´€ë¦¬ì ì¸ì¦</h1>
      <form id="loginForm" class="login-form">
        <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" required class="password-input"/>
        <button type="submit" class="btn-login">ë¡œê·¸ì¸</button>
      </form>
      <div id="loginError" class="error-message"></div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë©”ì¸ í™”ë©´ -->
  <div id="adminMain" class="admin-container" style="display: none;">
    <button class="btn-back" onclick="location.href='admin.html'">â† ê´€ë¦¬ì í™ˆìœ¼ë¡œ</button>
    
    <div class="container">
      <h1 class="section-title">ğŸ¯ ë¯¸ì…˜ ì œì¶œ ë‚´ì—­</h1>
      
      <button onclick="handleBulkDelete()" class="btn btn-danger" style="margin-bottom: 16px; display: none;" id="bulkDeleteBtn">ğŸš¨ ì „ì²´ ì œì¶œ ë°˜ë ¤</button>
      
      <div id="submissionList" style="padding: 16px; background: white; border-radius: 12px;">ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <script src="js/common.js"></script>
  <script>
    function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      document.getElementById('loginScreen').style.setProperty('display', isLoggedIn ? 'none' : 'block', 'important');
      document.getElementById('adminMain').style.setProperty('display', isLoggedIn ? 'block' : 'none', 'important');
    }

    async function handleLogin(event) {
      event.preventDefault();
      const password = document.getElementById('adminPassword').value;
      try {
        const res = await fetch('https://ul4jxnpezi.execute-api.ap-northeast-2.amazonaws.com/admin/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password })
        });
        const result = await res.json();
        if (result.success) {
          localStorage.setItem('adminLoggedIn', 'true');
          checkLoginStatus();
          document.getElementById('loginError').textContent = '';
        } else {
          document.getElementById('loginError').textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        }
      } catch (err) {
        document.getElementById('loginError').textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    }

    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    checkLoginStatus();

    const roomId = new URLSearchParams(location.search).get("roomId");

    if (!roomId) {
      document.getElementById("submissionList").innerHTML = "<p style='color: #e53e3e; text-align: center; padding: 20px;'>âŒ roomIdê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>";
    } else {
      // ì „ì²´ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      if (bulkDeleteBtn) {
        bulkDeleteBtn.style.display = 'block';
      }
      loadSubmissions();
    }

    async function loadSubmissions() {
      try {
        // 1. ë¨¼ì € ëª¨ë“  ê¸€ë¡œë²Œ ë¯¸ì…˜ ê°€ì ¸ì˜¤ê¸°
        const missionsRes = await callAPI(`/admin/missions`, "GET");
        const missions = Array.isArray(missionsRes) ? missionsRes : [];
        
        if (missions.length === 0) {
          document.getElementById("submissionList").innerHTML = "<p style='color: #999; text-align: center; padding: 20px;'>ë“±ë¡ëœ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        // 2. ê° ë¯¸ì…˜ë³„ë¡œ ì œì¶œ ë‚´ì—­ ì¡°íšŒ
        const allSubmissions = [];
        for (const mission of missions) {
          try {
            const res = await callAPI(`/missions/submissions?roomId=${roomId}&missionId=${mission.missionId}`, "GET");
            const subs = Array.isArray(res) ? res : (res.submissions || []);
            
            // ë¯¸ì…˜ ì œëª© ì¶”ê°€
            subs.forEach(sub => {
              sub.missionTitle = mission.title;
              sub.missionId = mission.missionId;
            });
            
            allSubmissions.push(...subs);
          } catch (err) {
            console.warn(`ë¯¸ì…˜ ${mission.missionId} ì œì¶œ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:`, err);
          }
        }

        const container = document.getElementById("submissionList");
        container.innerHTML = "";

        if (allSubmissions.length === 0) {
          container.innerHTML = "<p style='color: #999; text-align: center; padding: 20px;'>ì œì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        const submissions = allSubmissions;

        submissions.forEach(sub => {
          const card = document.createElement("div");
          card.className = "card-item";
          card.style.cssText = "margin-bottom: 16px; padding: 16px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;";

          const imageUrl = sub.imageUrl ? encodeURI(sub.imageUrl) : null;

          card.innerHTML = `
            <strong style="font-size: 16px; color: #2d3748;">${sub.nickname || "(ë‹‰ë„¤ì„ ì—†ìŒ)"}</strong><br/>
            <span style="color: #4a5568;">ğŸ¯ ë¯¸ì…˜: ${sub.missionTitle || sub.missionId || "-"}</span><br/>
            <span style="color: #718096;">ğŸ§© ìƒëŒ€: ${sub.targetCode || "-"}</span><br/>
            <span style="color: #4a5568;">â° ${sub.completedAt || "-"}</span><br/>
            ${imageUrl ? `<img src="${imageUrl}" style="max-width: 150px; width: auto; height: auto; display: block; margin-top: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="openImageModal('${imageUrl}')" onerror="this.style.display='none';">` : ""}
          `;

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "âŒ ë°˜ë ¤";
          deleteBtn.className = "btn btn-danger";
          deleteBtn.style.cssText = "margin-top: 12px; padding: 8px 16px; background: #e53e3e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;";
          deleteBtn.onclick = () => deleteSubmission(sub.missionId, sub.phone);
          
          card.appendChild(deleteBtn);
          container.appendChild(card);
        });
      } catch (err) {
        console.error("ì œì¶œ ë‚´ì—­ ë¡œë”© ì‹¤íŒ¨", err);
        document.getElementById("submissionList").innerHTML = `<p style='color: #e53e3e; text-align: center; padding: 20px;'>âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}</p>`;
      }
    }

    async function deleteSubmission(missionId, phone) {
      if (!confirm("ì •ë§ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      try {
        const payload = { roomId, missionId, phone };
        await callAPI("/missions/submission/delete", "POST", payload);
        alert("ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadSubmissions();
      } catch (err) {
        alert("âŒ ë°˜ë ¤ ì‹¤íŒ¨: " + err.message);
      }
    }

    // ì „ì²´ ì œì¶œ ë°˜ë ¤
    async function handleBulkDelete() {
      if (!confirm("ì •ë§ë¡œ ì´ ë°©ì˜ ëª¨ë“  ë¯¸ì…˜ ì œì¶œì„ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

      try {
        const payload = { roomId };
        await callAPI("/missions/deleteAllByRoom", "POST", payload);
        alert("ì „ì²´ ë°˜ë ¤ ì™„ë£Œ");
        loadSubmissions();
      } catch (err) {
        alert("âŒ ì „ì²´ ë°˜ë ¤ ì‹¤íŒ¨: " + err.message);
      }
    }

    // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
    window.openImageModal = (imageUrl) => {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; cursor: pointer;';
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
      
      modal.appendChild(img);
      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    };
  </script>
</body>
</html>

