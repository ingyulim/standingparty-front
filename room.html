<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°© ì…ì¥ - Standing Party</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="room-container">
    <button class="btn-back" onclick="location.href='index.html'">â† ë‚˜ê°€ê¸°</button>

    <header class="room-header glass-card">
      <h1 id="roomTitle">Standing Party</h1>
      <p id="userInfo"></p>
    </header>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="room-tabs glass-card">
      <button id="participantsTabBtn" class="tab-btn active" onclick="switchTab('participants')">
        ğŸ‘¥ ì°¸ì—¬ì (<span id="participantCount">0</span>)
      </button>
      <button id="missionsTabBtn" class="tab-btn" onclick="switchTab('missions')" style="display: none">
        ğŸ§© ë¯¸ì…˜ (<span id="missionCount">0</span>)
      </button>
    </nav>

    <!-- ì°¸ì—¬ì -->
    <section id="tab-participants" class="tab-content glass-card">
      <div id="participantList" class="list-box"></div>
    </section>

    <!-- ë¯¸ì…˜ -->
    <section id="tab-missions" class="tab-content glass-card hidden">
      <div id="missionList" class="list-box"></div>
    </section>
  </div>

  <script src="js/common.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const roomId = params.get("roomId");
      const phone = params.get("phone");
      const code = params.get("code");
      const nickname = params.get("nickname");

      if (!roomId || !phone || !code || !nickname) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        location.href = "index.html";
        return;
      }

      document.getElementById("userInfo").textContent = `âœ… ${nickname} (#${code}) ë¡œ ì…ì¥`;

      // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ì‚¬ìš©ì ì½”ë“œ ì €ì¥ (ë³¸ì¸ í™•ì¸ìš©)
      window.currentUserCode = code;

      // ë°© ì •ë³´ì—ì„œ ë¯¸ì…˜ í™œì„±í™” ì—¬ë¶€ ê°€ì ¸ì˜¤ê¸°
      let missionActive = false;
      try {
        const rooms = await callAPI("/rooms", "GET");
        const currentRoom = rooms.find(r => (r.id || r.roomId) === roomId);
        if (currentRoom) {
          const roomName = currentRoom.title || currentRoom.name || "Standing Party";
          document.getElementById("roomTitle").textContent = roomName;
          missionActive = currentRoom.missionActive === true || currentRoom.missionActive === "true";
          console.log("ğŸ§© missionActive (from DB):", missionActive);
        }
      } catch (e) {
        console.warn("ë°© ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
      }

      // ì „ì—­ ë³€ìˆ˜ë¡œ ë¯¸ì…˜ ìƒíƒœ ì €ì¥ (missionActive ì„¤ì • í›„)
      window.currentMissionActive = missionActive;

      // ë¯¸ì…˜ íƒ­ í‘œì‹œ ì—¬ë¶€ ê²°ì •
      const missionTabBtn = document.getElementById("missionsTabBtn");
      const missionTabContent = document.getElementById("tab-missions");

      if (missionActive) {
        missionTabBtn.style.display = "inline-block";
        loadMissions();
        console.log("ğŸ¯ ë¯¸ì…˜ íƒ­ í™œì„±í™”ë¨");
      } else {
        missionTabBtn.remove();
        missionTabContent.remove();
        console.log("ğŸ¯ ë¯¸ì…˜ íƒ­ ì œê±°ë¨");
      }

      loadParticipants();

      async function loadParticipants() {
        try {
          const data = await callAPI(`/participants?roomId=${roomId}`, "GET");
          const list = data?.participants || data || [];
          const div = document.getElementById("participantList");
          div.innerHTML = "";
          document.getElementById("participantCount").textContent = list.length;

          if (!Array.isArray(list) || list.length === 0) {
            div.innerHTML = "<p>ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }

          list.forEach((p) => {
            const name = p.nickname?.S || p.nickname || "ì´ë¦„ì—†ìŒ";
            const code = p.code?.S || p.code || "----";
            const pt = p.points?.N || p.points || "0";
            const gender = p.gender?.S || p.gender || "-";
            const genderIcon = gender === "M" ? "ğŸ‘¨" : gender === "F" ? "ğŸ‘©" : "ğŸ‘¤";
            const genderText = gender === "M" ? "ë‚¨ì" : gender === "F" ? "ì—¬ì" : "";
            const el = document.createElement("div");
            // ì„±ë³„ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€
            const genderClass = gender === "M" ? "participant-male" : gender === "F" ? "participant-female" : "";
            el.className = `card-item ${genderClass}`;
            // ë³¸ì¸ì¸ì§€ í™•ì¸
            const isMe = (code === window.currentUserCode);
            const pointsDisplay = isMe ? `<strong style="color: #FFD700; font-size: 1.3em; font-weight: bold; text-shadow: 0 0 10px #FFD700;">${pt}ì </strong>` : "";

            el.innerHTML = `${genderIcon} ${name} (#${code}) Â· ${genderText}${pointsDisplay ? ` Â· ${pointsDisplay}` : ""}`;
            div.appendChild(el);
          });
        } catch (err) {
          console.error(err);
          alert("ì°¸ì—¬ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function loadMissions() {
        try {
          const data = await callAPI(`/missions/my?roomId=${roomId}&phone=${phone}`, "GET");
          const missions = data || [];
          const div = document.getElementById("missionList");
          div.innerHTML = "";
          document.getElementById("missionCount").textContent = missions.length;

          if (!missions.length) {
            div.innerHTML = "<p>ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }

          let completedCount = 0;

          missions.forEach((m) => {
            // ì™„ë£Œëœ ë¯¸ì…˜ ìˆ˜ ê³„ì‚°
            if (m.done) {
              completedCount++;
            }

            const section = document.createElement("div");
            section.className = `mission-card${m.done ? " mission-completed" : ""}`;
            section.innerHTML = `
              <h4 style="margin-bottom: 8px; font-size: 16px; font-weight: bold;">${m.title} (${m.points}ì )</h4>
              <p style="margin-bottom: 16px; line-height: 1.4; opacity: 0.9;">${m.description}</p>
              <div style="margin-top: 12px;">
                ${m.done ? "âœ… ì™„ë£Œë¨" : `
                  <input type="text" placeholder="ìƒëŒ€ ì½”ë“œ ì…ë ¥" id="input-${m.id}" style="margin-bottom: 8px;" />
                  <button class="btn-small" onclick="submitMission('${m.id}')">ì œì¶œ</button>
                `}
              </div>
            `;
            div.appendChild(section);
          });

          // ë¯¸ì…˜ ì§„í–‰ë¥  ì„¹ì…˜ ì¶”ê°€ (í•˜ë‹¨ì—)
          const progressSection = document.createElement("div");
          progressSection.className = "mission-progress-section";
          progressSection.innerHTML = `
            <h3>ë¯¸ì…˜ ì§„í–‰ë¥ </h3>
            <div class="progress-text">ì™„ë£Œ: <span id="completedCount">0</span> / ${missions.length}</div>
            <div class="progress-bar">
              <div class="progress-fill" id="missionProgressFill"></div>
            </div>
          `;
          div.appendChild(progressSection);

          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          updateMissionProgress(completedCount, missions.length);
        } catch (err) {
          console.error(err);
          alert("ë¯¸ì…˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¯¸ì…˜ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateMissionProgress(completed, total) {
        const completedEl = document.getElementById("completedCount");
        const progressFill = document.getElementById("missionProgressFill");

        if (completedEl) completedEl.textContent = completed;

        if (progressFill && total > 0) {
          const percentage = (completed / total) * 100;
          progressFill.style.width = `${percentage}%`;
        } else if (progressFill) {
          progressFill.style.width = "0%";
        }
      }

      window.submitMission = async (missionId) => {
        const input = document.getElementById(`input-${missionId}`);
        const codeInput = input?.value?.trim();
        if (!codeInput) return alert("ìƒëŒ€ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
        try {
          const payload = { roomId, missionId, phone, targetCode: codeInput };
          const res = await callAPI("/missions/submit", "POST", payload);
          alert("ë¯¸ì…˜ ì™„ë£Œ! " + (res.points >= 0 ? "+" : "") + res.points + "ì ");
          loadMissions();
        } catch (err) {
          alert(err.message || "ì œì¶œ ì‹¤íŒ¨");
        }
      };
    });

    function switchTab(name) {
      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach((el) => el.classList.add("hidden"));
      document.getElementById(`tab-${name}`).classList.remove("hidden");
      document.getElementById(`${name}TabBtn`).classList.add("active");
    }
  </script>
</body>
</html>
