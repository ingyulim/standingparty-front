<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¯¸ì…˜ ê´€ë¦¬ - Standing Party</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <button class="btn-back" onclick="location.href='admin.html'">â† ê´€ë¦¬ì í™ˆìœ¼ë¡œ</button>

  <div class="container">
    <h1 class="section-title">ğŸ¯ ì „ì²´ ë¯¸ì…˜ ê´€ë¦¬</h1>

    <form id="missionForm" onsubmit="saveMission(); return false;">
      <input type="hidden" id="missionId" /> <!-- ìˆ¨ê²¨ì§„ í•„ë“œ -->

      <div class="form-group">
        <label for="title">ë¯¸ì…˜ ì œëª©</label>
        <input type="text" id="title" required />
      </div>
      <div class="form-group">
        <label for="description">ë¯¸ì…˜ ì„¤ëª…</label>
        <textarea id="description"></textarea>
      </div>
      <div class="form-group">
        <label for="points">ì ìˆ˜</label>
        <input type="number" id="points" required />
      </div>
      <button type="submit" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
    </form>

    <hr />

    <h2>ğŸ“‹ ë“±ë¡ëœ ë¯¸ì…˜ ëª©ë¡</h2>
    <ul id="missionList"></ul>
  </div>

  <script src="js/common.js"></script>
  <script>
    let editing = false;

    async function fetchMissions() {
      // ğŸ” ì—¬ëŸ¬ ê°€ëŠ¥í•œ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„
      const possibleEndpoints = [
        "/admin/missions",
        "/missions/global", 
        "/global-missions",
        "/admin/global-missions"
      ];
      
      for (const endpoint of possibleEndpoints) {
        try {
          console.log(`ğŸ” ë¯¸ì…˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„: ${endpoint}`);
          const missions = await callAPI(endpoint, "GET");
          console.log(`âœ… ë¯¸ì…˜ ì‘ë‹µ (${endpoint}):`, missions);
        
        const listEl = document.getElementById("missionList");
        listEl.innerHTML = "";
        
        if (!Array.isArray(missions) || missions.length === 0) {
          listEl.innerHTML = "<li>ë“±ë¡ëœ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
          return;
        }
        
          missions.forEach((m) => {
            const li = document.createElement("li");
            li.innerHTML = `
              <b>${m.missionId}</b> - ${m.title} (${m.points}ì )
              <br />${m.description || ""}
              <br />
              <button onclick='editMission(${JSON.stringify(m)})'>âœï¸ ìˆ˜ì •</button>
              <button onclick='deleteMission("${m.missionId}")'>ğŸ—‘ ì‚­ì œ</button>
              <hr />
            `;
            listEl.appendChild(li);
          });
          
          console.log(`ğŸ¯ ì„±ê³µí•œ ì—”ë“œí¬ì¸íŠ¸: ${endpoint}`);
          return; // ì„±ê³µí•˜ë©´ ë” ì´ìƒ ì‹œë„í•˜ì§€ ì•ŠìŒ
          
        } catch (err) {
          console.warn(`âŒ ${endpoint} ì‹¤íŒ¨:`, err.message);
          continue; // ë‹¤ìŒ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„
        }
      }
      
      // ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨
      console.error("âŒ ëª¨ë“  ë¯¸ì…˜ ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨");
      const listEl = document.getElementById("missionList");
      listEl.innerHTML = `<li style="color: red;">ë¯¸ì…˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>`;
    }

    async function saveMission() {
      try {
        const missionIdInput = document.getElementById("missionId");
        let missionId = missionIdInput.value;

        if (!missionId) {
          missionId = `mission-${Date.now()}`; // ìë™ ìƒì„±
        }

        const data = {
          missionId,
          title: document.getElementById("title").value,
          description: document.getElementById("description").value,
          points: Number(document.getElementById("points").value)
        };

        console.log("ğŸ’¾ ë¯¸ì…˜ ì €ì¥ ì‹œë„:", data);
        await callAPI("/admin/missions", "POST", data);
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById("missionForm").reset();
        missionIdInput.value = ""; // hidden í•„ë“œ ì´ˆê¸°í™”
        editing = false;
        fetchMissions();
      } catch (err) {
        console.error("âŒ ë¯¸ì…˜ ì €ì¥ ì‹¤íŒ¨:", err);
        alert(`ì €ì¥ ì‹¤íŒ¨: ${err.message}`);
      }
    }

    async function deleteMission(missionId) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      try {
        console.log("ğŸ—‘ ë¯¸ì…˜ ì‚­ì œ ì‹œë„:", missionId);
        await callAPI("/admin/missions", "DELETE", { missionId });
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        fetchMissions();
      } catch (err) {
        console.error("âŒ ë¯¸ì…˜ ì‚­ì œ ì‹¤íŒ¨:", err);
        alert(`ì‚­ì œ ì‹¤íŒ¨: ${err.message}`);
      }
    }

    function editMission(m) {
      document.getElementById("missionId").value = m.missionId;
      document.getElementById("title").value = m.title;
      document.getElementById("description").value = m.description;
      document.getElementById("points").value = m.points;
      editing = true;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    fetchMissions();
  </script>
</body>
</html>
